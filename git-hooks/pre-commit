#!/bin/bash
# Pre-commit hook for secure Kubernetes Flask PoC

set -e

echo "ğŸ” Running pre-commit security checks..."

# Check for secrets in staged files
if command -v gitleaks &> /dev/null; then
    echo "ğŸ” Scanning for secrets..."
    gitleaks detect --staged --verbose --no-git
else
    echo "âš ï¸  gitleaks not installed, skipping secret scan"
fi

# Lint YAML files
if command -v yamllint &> /dev/null; then
    echo "ğŸ“ Linting YAML files..."
    yamllint k8s/ .github/ || echo "âš ï¸  YAML linting issues found"
else
    echo "âš ï¸  yamllint not installed, skipping YAML lint"
fi

# Format Python code
if command -v black &> /dev/null; then
    echo "ğŸ Checking Python formatting..."
    black --check app/ || {
        echo "âŒ Python code not formatted. Run: black app/"
        exit 1
    }
else
    echo "âš ï¸  black not installed, skipping Python format check"
fi

# Check Dockerfile security
if command -v hadolint &> /dev/null; then
    echo "ğŸ³ Checking Dockerfile security..."
    hadolint app/Dockerfile || echo "âš ï¸  Dockerfile issues found"
else
    echo "âš ï¸  hadolint not installed, skipping Dockerfile check"
fi

echo "âœ… Pre-commit checks completed"